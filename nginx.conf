user www-data;
worker_processes auto;
pid /run/nginx.pid;
error_log /var/log/nginx/error.log;
include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections 1024;
    # multi_accept on;
}

http {

    map $remote_addr $limit_bypass {
        # Cloudflare IP-alueet
        103.21.244.0/22     "";
        103.22.200.0/22     "";
        103.31.4.0/22       "";
        104.16.0.0/13       "";
        104.24.0.0/14       "";
        108.162.192.0/18    "";
        131.0.72.0/22       "";
        141.101.64.0/18     "";
        162.158.0.0/15      "";
        172.64.0.0/13       "";
        173.245.48.0/20     "";
        188.114.96.0/20     "";
        190.93.240.0/20     "";
        197.234.240.0/22    "";
        198.41.128.0/17     "";
        default             "req_limit";
    }

    ##
    # Basic Settings
    ##

    sendfile on;
    tcp_nopush on;
    types_hash_max_size 2048;
    server_tokens off;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    ##
    # SSL Settings
    ##

    ssl_protocols TLSv1.2 TLSv1.3;  # Poistetaan vanhentuneet TLSv1/1.1
    ssl_prefer_server_ciphers on;

    ##
    # Logging
    ##

    access_log /var/log/nginx/access.log;

    ##
    # Gzip
    ##

    gzip on;

    ##
    # Rate limiting & connection limiting (globaalit zonet)
    ##
    limit_req_zone $binary_remote_addr zone=req_limit:10m rate=5r/s;
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

    ##
    # Security headers (otetaan käyttöön server-lohkoissa)
    ##

    add_header Content-Security-Policy "default-src 'self'; img-src 'self' data:; script-src 'self'; style-src 'self';" always;
    add_header Referrer-Policy "no-referrer" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Permissions-Policy "geolocation=(), camera=(), microphone=()" always;

    ##
    # Virtual Hosts
    ##

    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}
